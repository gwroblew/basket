{% extends "/base.html" %}
{% set active_page = "ctrl.bluetooth" %}
{% block icon %}{{ icon('bluetooth') }}{% endblock %}
{% block head %}
  <style>.form-group {list-style-type: none}</style>
{% endblock %}
{% block content %}
    <div id="ws-connected" class="alert alert-success alert-dismissible" role="alert" hidden>
        WebSocket is connected. This page will automatically update.
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <div id="ws-error" class="alert alert-danger alert-dismissible" role="alert" hidden>
        The WebSocket closed unexpectedly. This page will not automatically update.
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    <p>BLE devices in range of this Basket instance:</p>
    <ul class="form-group">
      {% for device in devices %}
      {% set is_egg = device['name'] is not none and device['name'].lower().startswith('egg') -%}
      <li>
        <span class="btn-group"{% if is_egg %} title="Potential egg"{% endif %}>
          <label class="btn btn-outline-{{ 'primary' if is_egg else 'secondary' }}" title="RSSI: {{ device['rssi'] if device['rssi'] is not none else 'unknown' }}" disabled>{{ icon('radio-tower') }}</label>
          <label class="btn btn-outline-{{ 'primary' if is_egg else 'secondary' }}"><samp>{{ device['macaddr'] }}{% if device['name'] is not none %}</samp> ({{ device['name'] }}){% endif %}</label>
        </span>
      </li>
      {% endfor %}
    </ul>
{% endblock %}
{% block script %}
<script>
const proto = (location.protocol == "https:" ? "wss:" : "ws:") + "//";
const socket = new WebSocket(proto + location.host + location.pathname + "/ws");

socket.addEventListener("message", function (evt) {
    if (event.data === "reload") {
        location.reload(true);
    }
});

socket.addEventListener("open", function(evt) {
    document.getElementById("ws-connected").removeAttribute("hidden");
});

socket.addEventListener("close", function(evt) {
    document.getElementById("ws-connected").setAttribute("hidden", true);
    document.getElementById("ws-error").removeAttribute("hidden");
});

socket.addEventListener("error", function(evt) {
    document.getElementById("ws-connected").setAttribute("hidden", true);
    let err = document.getElementById("ws-error");
    err.innerText = "There was an error with the WebSocket: " + evt + " This page will not automatically update.";
    err.removeAttribute("hidden");
});

Array.prototype.forEach.call(document.getElementsByClassName("alert"), function(el) {
    el.getElementsByTagName("button")[0].addEventListener("click", function() {
        el.setAttribute("hidden", true);
    });
});

document.getElementById("ws-connected").removeAttribute("hidden");
</script>
{% endblock %}
